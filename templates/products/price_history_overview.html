{% extends 'base.html' %}
{% load static %}
{% block content %}

{% comment %} <div class="container mx-auto p-6 space-y-8"> {% endcomment %}
    <div class="flex flex-col gap-6">
        <!-- Header & Filtros -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Visão Geral de Preços</h1>
                <p class="text-muted-foreground">Acompanhe a evolução e volatilidade dos preços do seu inventário.</p>
            </div>
        </div>

        <form method="get" class="card p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="field col-span-1 md:col-span-2 lg:col-span-1">
                    <div class="relative">
                        <i data-lucide="search"
                            class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"></i>
                        <input type="text" name="q" value="{{ q|default:'' }}" placeholder="Buscar nome ou desc..."
                            class="input w-full pl-10">
                    </div>
                </div>

                <div class="field relative" id="category-filter-command">
                    <!-- Hidden Input to store the actual value -->
                    <input type="hidden" name="category" id="hidden-category-id"
                        value="{{ selected_category|default:'' }}">

                    <!-- Display Area / Search Input -->
                    <div class="relative group cursor-pointer">
                        <i data-lucide="tag"
                            class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground group-focus-within:text-primary transition-colors"></i>
                        <input type="text" id="category-filter-search" autocomplete="off"
                            placeholder="Todas as Categorias"
                            class="input w-full pl-10 cursor-pointer focus:cursor-text"
                            value="{% for cat in categorias %}{% if selected_category == cat.id|stringformat:'i' %}{{ cat.name }}{% endif %}{% endfor %}">
                        <i data-lucide="chevron-down"
                            class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground transition-transform group-focus-within:rotate-180"></i>
                    </div>

                    <!-- Command Menu -->
                    <div id="category-filter-menu"
                        class="hidden absolute top-full left-0 w-full mt-2 z-50 card shadow-xl border-border p-1 animate-in fade-in slide-in-from-top-2 duration-200">
                        <div class="max-h-60 overflow-y-auto custom-scrollbar" id="category-options-list">
                            <div
                                class="p-2 border-b border-border/50 text-[10px] font-bold uppercase text-muted-foreground tracking-widest px-3">
                                Categorias
                            </div>
                            <div class="p-1">
                                <div class="category-option p-2.5 flex items-center justify-between hover:bg-muted rounded-md cursor-pointer transition-colors text-sm {% if not selected_category %}bg-primary/5 text-primary font-bold{% endif %}"
                                    data-id="">
                                    <span>Todas as Categorias</span>
                                    {% if not selected_category %}<i data-lucide="check"
                                        class="w-4 h-4 text-primary"></i>{% endif %}
                                </div>
                                {% for cat in categorias %}
                                <div class="category-option p-2.5 flex items-center justify-between hover:bg-muted rounded-md cursor-pointer transition-colors text-sm {% if selected_category == cat.id|stringformat:'i' %}bg-primary/5 text-primary font-bold{% endif %}"
                                    data-id="{{ cat.id }}" data-name="{{ cat.name }}">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full" style="background-color: {{ cat.color }}">
                                        </div>
                                        <span>{{ cat.name }}</span>
                                    </div>
                                    {% if selected_category == cat.id|stringformat:'i' %}<i data-lucide="check"
                                        class="w-4 h-4 text-primary"></i>{% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div id="no-category-found" class="hidden p-8 text-center text-sm text-muted-foreground">
                                Nenhuma categoria encontrada.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button type="submit"
                        class="btn btn-ghost border border-border bg-transparent flex-1 h-9 text-foreground hover:bg-muted font-bold">
                        Filtrar
                    </button>
                    <a href="{% url 'price_history_overview' %}"
                        class="btn btn-ghost border border-border bg-transparent p-2 h-9 text-foreground hover:bg-muted"
                        title="Limpar Filtros">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </a>
                </div>
            </div>
        </form>

        <!-- Cards de Estatísticas -->
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            <!-- Total Alterações -->
            <div class="card p-6">
                <div class="flex items-center justify-between space-y-0 pb-2">
                    <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Total de Alterações</h3>
                    <i data-lucide="activity" class="w-4 h-4 text-muted-foreground"></i>
                </div>
                <div class="text-2xl font-bold">{{ total_alteracoes }}</div>
                <p class="text-xs text-muted-foreground">Registradas no histórico</p>
            </div>

            <!-- Maior Aumento -->
            <div class="card p-6">
                <div class="flex items-center justify-between space-y-0 pb-2">
                    <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Maior Aumento</h3>
                    <i data-lucide="trending-up" class="w-4 h-4 text-green-500"></i>
                </div>
                {% if maior_aumento.produto %}
                <div class="text-2xl font-bold text-green-600">+{{ maior_aumento.percentual|floatformat:1 }}%</div>
                <p class="text-xs text-muted-foreground truncate" title="{{ maior_aumento.produto.name }}">
                    {{ maior_aumento.produto.name }}
                </p>
                {% else %}
                <div class="text-2xl font-bold">-</div>
                <p class="text-xs text-muted-foreground">Sem dados recentes</p>
                {% endif %}
            </div>

            <!-- Maior Redução -->
            <div class="card p-6">
                <div class="flex items-center justify-between space-y-0 pb-2">
                    <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Maior Redução</h3>
                    <i data-lucide="trending-down" class="w-4 h-4 text-red-500"></i>
                </div>
                {% if maior_reducao.produto %}
                <div class="text-2xl font-bold text-red-600">-{{ maior_reducao.percentual|floatformat:1 }}%</div>
                <p class="text-xs text-muted-foreground truncate" title="{{ maior_reducao.produto.name }}">
                    {{ maior_reducao.produto.name }}
                </p>
                {% else %}
                <div class="text-2xl font-bold">-</div>
                <p class="text-xs text-muted-foreground">Sem dados recentes</p>
                {% endif %}
            </div>

            <!-- Média por Produto -->
            <div class="card p-6">
                <div class="flex items-center justify-between space-y-0 pb-2">
                    <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Média de Alterações</h3>
                    <i data-lucide="bar-chart-2" class="w-4 h-4 text-muted-foreground"></i>
                </div>
                <div class="text-2xl font-bold">{{ media_alteracoes|floatformat:1 }}</div>
                <p class="text-xs text-muted-foreground">Por produto ativo</p>
            </div>
        </div>

        <!-- Tabela de Produtos -->
        <div class="card overflow-hidden">
            <div class="p-6 border-b border-border">
                <h3 class="font-semibold text-lg">Detalhamento por Produto</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-muted/50 text-muted-foreground font-medium">
                        <tr>
                            <th class="px-6 py-3">Produto</th>
                            <th class="px-6 py-3">Preço Atual</th>
                            <th class="px-6 py-3 text-center">Tendência</th>
                            <th class="px-6 py-3">Última Alteração</th>
                            <th class="px-6 py-3 w-50">Histórico (Últimas 10)</th>
                            <th class="px-6 py-3 text-right"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-border">
                        {% for item in produtos_com_historico %}
                        <tr class="hover:bg-muted/30 transition-colors">
                            <td class="px-6 py-4">
                                <div class="font-medium">{{ item.produto.name }}</div>
                                <div class="flex gap-1 mt-1">
                                    {% for cat in item.produto.categories.all %}
                                    <span
                                        class="badge text-[10px] py-0.5 px-2 border-none text-white font-bold uppercase"
                                        style="background-color: {{ cat.color }}">
                                        {{ cat.name }}
                                    </span>
                                    {% empty %}
                                    <span class="text-muted-foreground text-xs italic">Sem cat.</span>
                                    {% endfor %}
                                </div>
                            </td>
                            <td class="px-6 py-4 font-medium">
                                R$ {{ item.produto.price }}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if item.trend == 'up' %}
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">
                                    <i data-lucide="arrow-up" class="w-3 h-3 mr-1"></i> Subiu
                                </span>
                                {% elif item.trend == 'down' %}
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                                    <i data-lucide="arrow-down" class="w-3 h-3 mr-1"></i> Caiu
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400">
                                    <i data-lucide="minus" class="w-3 h-3 mr-1"></i> Estável
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-muted-foreground">
                                {{ item.ultima_alteracao.changed_at|date:"d/m/Y H:i" }}
                            </td>
                            <td class="px-6 py-4">
                                <!-- Sparkline Container -->
                                <svg class="sparkline w-32 h-8 text-primary"
                                    data-values="{{ item.historico_precos|safe }}">
                                </svg>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <a href="{% url 'price_history' item.produto.pk %}" class="btn btn-sm btn-ghost">
                                    Detalhes
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-muted-foreground">
                                Nenhum histórico de preço encontrado para os filtros selecionados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block extra_scripts %}
    <script src="{% static 'js/price_history_overview.js' %}" defer></script>
    {% endblock %}